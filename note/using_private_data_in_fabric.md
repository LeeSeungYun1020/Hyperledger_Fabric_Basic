# 패브릭에서 개인(비밀) 데이터 사용

## 개요

튜토리얼에서는 PDC(개인 데이터 컬렉션)를 사용하여 승인된 조직의 승인된 피어를 위해
블록체인 네트워크에서 개인 데이터를 저장하고 검색하는 방법을 설명한다.
컬렉션은 해당 컬렉션을 관리하는 정책이 포함된 컬렉션 정의 파일을 사용하여 지정된다.

이 튜토리얼의 정보는 개인 데티어 저장소와 해당 사용 사례에 대한 배경 지식을 갖추고 있다고 생각하고 진행되므로
사전에 개인 데이터 저장소와 그 예를 살펴보고 아래 내용을 진행하는 것이 추천된다.

이 튜토리얼에서는 개인 데이터 저장소와 그 사용 사례에 대한 배경 지식을 갖추고 있다고 생각하고 진행된다.
개인 데이터 저장소와 예에 대해 알고 있다면 바로 [튜토리얼](#에셋-전송-개인-데이터-샘플-사용-사례)을 진행하자.

## 배경 지식

### 개인 데이터
채널에 있는 조직 그룹이 해당 채널의 다른 조직으로부터 데이터를 비밀로 관리하고 싶은 경우,
해당 데이터에 접근할 필요가 있는 조직으로 구성된 새 채널을 만드는 방법을 생각할 수 있다.
그러나 이러한 경우마다 별도의 채널을 만드는 것은 추가적인 관리 오버헤드(체인코드 버젼, 방침, MSP 관리 등)를 발생시킨다.
또한 데이터 일부를 비공개로 유지하면서 모든 채널 참가자가 트랜잭션을 보도록 하는 경우를 허용하지 않는다.

이것이 패브릭이 개인 데이터 컬렉션(PDC)을 만드는 기능을 제공하는 이유다.
개인 데이터 컬렉션은 채널에 조직의 하위 집합을 정의하도록 허용하여
별도의 채널을 만들지 않고도 개인 데이터를 보증하고 커밋하고 쿼리할 수 있도록 한다.

개인 데이터 컬렉션은 체인코드 정의를 통해 명시적으로 정의할 수 있다.
추가적으로 모든 체인코드에는 조직별 개인 데이터를 위한 암시적인 개인 데이터 이름공간(namespace)이 예약되어 있다.
이 암시적 조직별 개인 데이터 컬렉션은 각 조직의 개인 데이터를 저장하는데 사용된다.
이는 조직이 소유한 에셋에 대한 세부 정보와 체인코드로 구현된 다자간 비즈니스 프로세스 단계에서
조직의 승인과 같은 단일 조직과 관련된 개인 데이터를 저장하려는 경우 유용하다.

### 개인 데이터 컬렉션
컬렉션은 아래 두 요소로 구성된다.
1. 실제 개인 데이터  
개인 데이터는 가십 프로토콜(gossip protocol)을 통해 볼 수 있는 권한이 있는 조직에만 P2P(peer to peer)로 전송된다.
이 데이터는 승인된 조직의 개인 상태(private state) 데이터베이스에 저장된다.
데이터베이스에는 이 허가된 피어에서만 체인코드로 접근할 수 있다.
오더링 서비스는 여기에 관여하지 않으며 개인 데이터를 볼 수 없다.
가십은 승인된 조직 전체에 개인 데이터를 P2P로 배포한다.
그러므로 채널에 앵커(anchor) 피어 설정이 필요하며
조직간 커뮤니케이션을 부트스트랩하기 위해 각 피어에 `CORE_PEER_GOSSIP_EXTERNALENDPOINT`를 구성해야 한다.  
(* 부트스트랩: 한 번 시작되면 알아서 진행되는 일련의 과정)

2. 데이터의 해시  
채널의 모든 피어에서 원장에 보증된, 주문된, 작성된 해당 데이터의 해시(hash).
해시는 트랜잭션의 증거로 제공되며 상태(state) 확인과 감사의 목적으로 사용될 수 있다.

컬렉션 멤버는 분쟁이 발생하거나 에셋을 제3자에게 양도하려는 경우에서와 같이
개인 데이터를 다른 구성원과 공유하도록 결정할 수 있다.
제3자는 개인 데이터의 해시를 계산하여 채널 원장의 상태와 일치하는지 확인하여
특정한 시점에 컬렉션 멤버 사이에 상태가 존재하였음을 증명할 수 있다.

경우에 따라 각각 단일 조직으로 구성된 컬렉션 집합을 갖도록 결정할 수 있다.
일례로 조직이 나중에 다른 채널의 메법와 공유하고 체인코드 트랜잭션에서 참조 가능하도록 
개인 데이터를 자체 컬렉션에 기록할 수 있다. 아래 [개인 데이터 공유](#개인-데이터-공유)에서 이 예를 살펴보자.

#### 채널 내에서 컬렉션 사용하기 VS 별도의 채널에서 컬렉션 사용하기
* 채널 사용: 전체 트랜잭션(과 원장)이 채널의 멤버인 조직 집합 내에서 비밀로 유지되어야 하는 경우
* 컬렉션 사용: 트랜잭션(과 원장)이 조직 집합 간에 공유되어야 하나 일부 조직만이 트랜잭션 중에 데이터에 접근해야 하는 경우
추가적으로 개인 데이터는 블록을 통하지 않고 P2P로 전송되기 때문에
오더링 서비스 노드로부터 트랜잭션 데이터를 기밀로 유지해야 하는 겨우 개인 데이터 컬렉션을 사용한다.

### 컬렉션 설명을 위한 예제

### 개인 데이터 트랜잭션 흐름

### 개인 데이터 공유

### 개인 데이터 삭제

## 에셋 전송 개인 데이터 샘플 사용 사례

## 컬렉션 정의 JSON 파일 빌드

## 체인코드 API를 이용한 개인 데이터 읽기/쓰기

## 네트워크 시작

## 개인 데이터 스마트 컨트랙트를 채널에 배포

## 신원(ID) 등록

## 개인 데이터에 에셋 생성

## 승인된 피어로 개인 데이터 쿼리

## 승인되지 않은 피어로 개인 데이터 쿼리

## 에셋 전송

## 개인 데이터 삭제

## 개인 데이터와 인덱스 사용

## 정리하기